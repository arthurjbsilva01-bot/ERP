<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EletronicFix | ERP Professional</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { 
            --p: 82 85% 62%; /* Verde Lima */
            --s: 24 95% 53%; /* Laranja */
        }
        body { background-color: #f8fafc; color: #1e293b; font-family: 'Inter', sans-serif; }
        .sidebar-bg { background-color: #0f172a; }
        .sidebar-active { background-color: rgba(179, 242, 77, 0.15); color: #b3f24d; border-left: 4px solid #b3f24d; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .card-fix { background: white; border: 1px solid #e2e8f0; border-radius: 1rem; }
        
        /* Badges de Status */
        .badge-aberta { background-color: #f97316; color: white; border: none; font-weight: bold; }
        .badge-finalizada { background-color: #b3f24d; color: #064e3b; border: none; font-weight: bold; }
        
        /* Ajuste de Modais para ficarem completos */
        .modal-box { max-height: 95vh; padding: 2rem; border-radius: 1.5rem; }
    </style>
</head>
<body class="min-h-screen">

    <div class="drawer lg:drawer-open">
        <input id="my-drawer" type="checkbox" class="drawer-toggle" />
        
        <div class="drawer-content flex flex-col">
            <main class="p-6 md:p-10">
                <section id="sec-dash" class="page-section active">
                    <h1 class="text-4xl font-black mb-10 text-slate-800 italic uppercase">Resumo EletronicFix</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div class="stats card-fix border-t-8 border-orange-500 shadow-lg">
                            <div class="stat">
                                <div class="stat-title text-orange-600 font-bold uppercase text-sm">O.S Abertas</div>
                                <div class="stat-value text-orange-600" id="dash-abertas">0</div>
                            </div>
                        </div>
                        <div class="stats card-fix border-t-8 border-green-500 shadow-lg">
                            <div class="stat">
                                <div class="stat-title text-green-600 font-bold uppercase text-sm">O.S Finalizadas</div>
                                <div class="stat-value text-green-600" id="dash-finalizadas">0</div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="sec-clientes" class="page-section">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-black text-slate-800 uppercase italic">Gest√£o de Clientes</h1>
                        <button class="btn bg-[#b3f24d] hover:bg-[#a2db45] border-none text-slate-900 font-black px-8" onclick="prepararNovoCliente()">+ NOVO CLIENTE</button>
                    </div>
                    <div class="card card-fix shadow-md overflow-x-auto">
                        <table class="table w-full">
                            <thead class="bg-slate-50 text-slate-500">
                                <tr><th>ID</th><th>NOME</th><th>WHATSAPP</th><th class="text-center">A√á√ïES</th></tr>
                            </thead>
                            <tbody id="lista-clientes" class="font-medium"></tbody>
                        </table>
                    </div>
                </section>

                <section id="sec-os" class="page-section">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-black text-slate-800 uppercase italic">Ordens de Servi√ßo</h1>
                        <button class="btn bg-[#b3f24d] hover:bg-[#a2db45] border-none text-slate-900 font-black px-8" onclick="prepararNovaOS()">+ NOVA OS</button>
                    </div>
                    <div class="card card-fix shadow-md overflow-x-auto">
                        <table class="table w-full">
                            <thead class="bg-slate-50 text-slate-500">
                                <tr><th>N¬∫ OS</th><th>CLIENTE</th><th>APARELHO</th><th>STATUS</th><th class="text-center">A√á√ïES</th></tr>
                            </thead>
                            <tbody id="lista-os" class="font-medium"></tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div>

        <div class="drawer-side z-20">
            <label for="my-drawer" class="drawer-overlay"></label>
            <aside class="sidebar-bg w-72 min-h-full flex flex-col text-white">
                <div class="p-8 border-b border-slate-800 text-center">
                    <img src="logo.png" class="h-32 mx-auto object-contain mb-2">
                </div>
                <ul class="menu p-4 gap-2 font-bold mt-4">
                    <li><a href="#" onclick="switchPage('sec-dash')" id="nav-dash" class="sidebar-active">üìä DASHBOARD</a></li>
                    <li><a href="#" onclick="switchPage('sec-clientes')" id="nav-clientes">üë• CLIENTES</a></li>
                    <li><a href="#" onclick="switchPage('sec-os')" id="nav-os">üõ†Ô∏è ORDENS DE SERVI√áO</a></li>
                </ul>
            </aside>
        </div>
    </div>

    <dialog id="modal_cliente" class="modal">
        <div class="modal-box w-11/12 max-w-4xl bg-white">
            <h3 class="font-black text-2xl text-slate-800 mb-8 border-b pb-4" id="titulo-modal-cliente">Cadastro de Cliente</h3>
            <form id="form-cliente" onsubmit="salvarCliente(event)" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <input type="hidden" id="c-id" value="">
                <input type="text" id="c-nome" placeholder="Nome Completo *" class="input input-bordered w-full" required />
                <input type="text" id="c-whatsapp" placeholder="WhatsApp" class="input input-bordered w-full" oninput="maskWhatsApp(this)" maxlength="15" />
                <input type="text" id="c-cpf" placeholder="CPF/CNPJ" class="input input-bordered w-full" oninput="maskCPF(this)" maxlength="18" />
                <input type="email" id="c-email" placeholder="E-mail" class="input input-bordered w-full" />
                <input type="text" id="c-cep" placeholder="CEP" class="input input-bordered" oninput="maskCEP(this)" maxlength="9" onblur="buscarCep(this.value)" />
                <input type="text" id="c-cidade" placeholder="Cidade" class="input input-bordered" />
                <input type="text" id="c-rua" placeholder="Rua" class="input input-bordered" />
                <input type="text" id="c-numero" placeholder="N¬∫" class="input input-bordered" />
                <div class="modal-action col-span-full border-t pt-6">
                    <button type="button" class="btn" onclick="modal_cliente.close()">Cancelar</button>
                    <button type="submit" class="btn bg-[#b3f24d] hover:bg-[#a2db45] text-slate-900 border-none px-10 font-black">Salvar Cliente</button>
                </div>
            </form>
        </div>
    </dialog>

    <dialog id="modal_os" class="modal">
        <div class="modal-box w-11/12 max-w-2xl bg-white">
            <h3 class="font-black text-2xl text-slate-800 mb-8 border-b pb-4" id="titulo-modal-os">Nova Ordem de Servi√ßo</h3>
            <form id="form-os" onsubmit="salvarOS(event)" class="space-y-6">
                <input type="hidden" id="os-id" value="">
                <select id="os-cliente" class="select select-bordered w-full font-bold" required></select>
                <input type="text" id="os-equipamento" placeholder="Aparelho / Equipamento" class="input input-bordered w-full" required />
                <textarea id="os-defeito" placeholder="Defeito Relatado" class="textarea textarea-bordered w-full h-24" required></textarea>
                <div class="grid grid-cols-3 gap-4">
                    <select id="os-status-form" class="select select-bordered w-full font-bold">
                        <option value="Aberta">Aberta</option>
                        <option value="Finalizada">Finalizada</option>
                    </select>
                    <input type="number" id="os-valor" placeholder="Valor R$" class="input input-bordered" step="0.01" />
                    <input type="number" id="os-garantia" placeholder="Garantia" class="input input-bordered" value="90" />
                </div>
                <div class="modal-action border-t pt-6">
                    <button type="button" class="btn" onclick="modal_os.close()">Cancelar</button>
                    <button type="submit" class="btn bg-[#b3f24d] hover:bg-[#a2db45] text-slate-900 border-none px-10 font-black">Salvar O.S</button>
                </div>
            </form>
        </div>
    </dialog>

    <script>
        const SUPABASE_URL = 'https://tiwolqggaatrrpuahsvu.supabase.co'
        const SUPABASE_KEY = 'sb_publishable_ro9Yx3P9H-nM9Vgt0lA6eg_Eoo_1Qqq'
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

        function maskWhatsApp(v) { v.value = v.value.replace(/\D/g, "").replace(/^(\d{2})(\d)/g, "($1) $2").replace(/(\d{5})(\d)/, "$1-$2"); }
        function maskCPF(v) { v.value = v.value.replace(/\D/g, "").replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d{1,2})$/, "$1-$2"); }
        function maskCEP(v) { v.value = v.value.replace(/\D/g, "").replace(/^(\d{5})(\d)/, "$1-$2"); }

        function switchPage(p) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(p).classList.add('active');
            document.querySelectorAll('.sidebar-active').forEach(a => a.classList.remove('sidebar-active'));
            document.getElementById('nav-' + p.split('-')[1]).classList.add('sidebar-active');
            atualizarDados();
        }

        async function atualizarDados() {
            const { count: aCount } = await _supabase.from('ordens_servico').select('*', { count: 'exact', head: true }).eq('status', 'Aberta');
            const { count: fCount } = await _supabase.from('ordens_servico').select('*', { count: 'exact', head: true }).eq('status', 'Finalizada');

            document.getElementById('dash-abertas').innerText = aCount || 0;
            document.getElementById('dash-finalizadas').innerText = fCount || 0;
            
            await carregarClientes(); await carregarOS();
        }

        async function carregarClientes() {
            const { data } = await _supabase.from('clientes').select('*').order('id', {ascending: false});
            const lista = document.getElementById('lista-clientes'); lista.innerHTML = '';
            data.forEach(c => {
                lista.innerHTML += `<tr>
                    <td class="text-xs font-black text-slate-400">#${c.id}</td>
                    <td class="font-black text-slate-800">${c.nome}</td>
                    <td>${c.whatsapp || '-'}</td>
                    <td class="text-center flex justify-center gap-2">
                        <button onclick="abrirEdicaoCliente(${c.id})" class="btn btn-xs border-slate-200 bg-slate-50 text-slate-600 font-bold hover:bg-slate-200">EDITAR</button>
                        <button onclick="excluirCliente(${c.id})" class="btn btn-xs border-red-100 bg-red-50 text-red-500 font-bold hover:bg-red-100">EXCLUIR</button>
                    </td></tr>`;
            });
            const sel = document.getElementById('os-cliente'); sel.innerHTML = '<option value="">Selecione o Cliente...</option>';
            data.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.nome}</option>`);
        }

        async function carregarOS() {
            const { data } = await _supabase.from('ordens_servico').select('*, clientes(nome)').order('id', {ascending: false});
            const lista = document.getElementById('lista-os'); lista.innerHTML = '';
            data.forEach(os => {
                const badge = os.status === 'Aberta' ? 'badge-aberta' : 'badge-finalizada';
                lista.innerHTML += `<tr>
                    <td class="font-black text-slate-800">#${os.id}</td>
                    <td class="font-black text-xs uppercase">${os.clientes ? os.clientes.nome : 'N/A'}</td>
                    <td>${os.equipamento}</td>
                    <td><span onclick="alternarStatus(${os.id}, '${os.status}')" class="badge badge-lg ${badge} cursor-pointer hover:opacity-80">${os.status.toUpperCase()}</span></td>
                    <td class="flex justify-center gap-2">
                        <button onclick="abrirEdicaoOS(${os.id})" class="btn btn-xs bg-slate-100 text-slate-600 font-bold border-none">EDITAR</button>
                        <button onclick="gerarPDF_OS(${os.id})" class="btn btn-xs bg-slate-900 text-white font-bold border-none">O.S</button>
                        <button onclick="gerarPDF_Garantia(${os.id})" class="btn btn-xs btn-outline font-bold">GARANTIA</button>
                    </td></tr>`;
            });
        }

        async function alternarStatus(id, atual) {
            const novo = atual === 'Aberta' ? 'Finalizada' : 'Aberta';
            await _supabase.from('ordens_servico').update({ status: novo }).eq('id', id);
            atualizarDados();
        }

        function prepararNovoCliente() { document.getElementById('form-cliente').reset(); document.getElementById('c-id').value = ""; document.getElementById('titulo-modal-cliente').innerText = "Cadastro de Cliente"; modal_cliente.showModal(); }
        async function abrirEdicaoCliente(id) { const { data: c } = await _supabase.from('clientes').select('*').eq('id', id).single(); document.getElementById('c-id').value = c.id; document.getElementById('c-nome').value = c.nome; document.getElementById('c-whatsapp').value = c.whatsapp || ''; document.getElementById('c-cpf').value = c.cpf_cnpj || ''; document.getElementById('c-email').value = c.email || ''; document.getElementById('c-cep').value = c.cep || ''; document.getElementById('c-cidade').value = c.cidade || ''; document.getElementById('c-rua').value = c.rua || ''; document.getElementById('c-numero').value = c.numero || ''; document.getElementById('titulo-modal-cliente').innerText = "Editar Cliente"; modal_cliente.showModal(); }
        async function salvarCliente(e) { e.preventDefault(); const id = document.getElementById('c-id').value; const p = { nome: document.getElementById('c-nome').value, whatsapp: document.getElementById('c-whatsapp').value, cpf_cnpj: document.getElementById('c-cpf').value, email: document.getElementById('c-email').value, cep: document.getElementById('c-cep').value, cidade: document.getElementById('c-cidade').value, rua: document.getElementById('c-rua').value, numero: document.getElementById('c-numero').value }; if(id) await _supabase.from('clientes').update(p).eq('id', id); else await _supabase.from('clientes').insert([p]); modal_cliente.close(); atualizarDados(); }
        async function excluirCliente(id) { if(confirm("Deseja excluir este cliente?")) { await _supabase.from('ordens_servico').delete().eq('cliente_id', id); await _supabase.from('clientes').delete().eq('id', id); atualizarDados(); } }

        function prepararNovaOS() { document.getElementById('form-os').reset(); document.getElementById('os-id').value = ""; document.getElementById('titulo-modal-os').innerText = "Nova Ordem de Servi√ßo"; modal_os.showModal(); }
        async function abrirEdicaoOS(id) { const { data: os } = await _supabase.from('ordens_servico').select('*').eq('id', id).single(); document.getElementById('os-id').value = os.id; document.getElementById('os-cliente').value = os.cliente_id; document.getElementById('os-equipamento').value = os.equipamento; document.getElementById('os-defeito').value = os.defeito_relatado; document.getElementById('os-status-form').value = os.status; document.getElementById('os-valor').value = os.valor_total; document.getElementById('os-garantia').value = os.garantia_dias; document.getElementById('titulo-modal-os').innerText = `Editar O.S #${os.id}`; modal_os.showModal(); }
        async function salvarOS(e) { e.preventDefault(); const id = document.getElementById('os-id').value; const p = { cliente_id: parseInt(document.getElementById('os-cliente').value), equipamento: document.getElementById('os-equipamento').value, defeito_relatado: document.getElementById('os-defeito').value, status: document.getElementById('os-status-form').value, valor_total: parseFloat(document.getElementById('os-valor').value || 0), garantia_dias: parseInt(document.getElementById('os-garantia').value || 90) }; if(id) await _supabase.from('ordens_servico').update(p).eq('id', id); else await _supabase.from('ordens_servico').insert([p]); modal_os.close(); atualizarDados(); }

        // --- PDFS PROFISSIONAIS ---

        async function gerarPDF_OS(id) {
            const { data: os } = await _supabase.from('ordens_servico').select('*, clientes(*)').eq('id', id).single();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(179, 242, 77); doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(0); doc.setFontSize(24); doc.setFont(undefined, 'bold'); doc.text('ORDEM DE SERVI√áO', 105, 25, {align: 'center'});
            doc.setFontSize(10); doc.setFont(undefined, 'normal');
            doc.text(`Protocolo: #${os.id} | Data: ${new Date().toLocaleDateString()}`, 15, 50);
            doc.line(15, 53, 195, 53);
            doc.setFont(undefined, 'bold'); doc.text('CLIENTE:', 15, 62); doc.setFont(undefined, 'normal');
            doc.text(`${os.clientes.nome} | Whats: ${os.clientes.whatsapp || '-'}`, 15, 68);
            doc.setFont(undefined, 'bold'); doc.text('APARELHO:', 15, 80); doc.setFont(undefined, 'normal');
            doc.text(`${os.equipamento}`, 15, 86);
            doc.setFont(undefined, 'bold'); doc.text('DEFEITO RELATADO:', 15, 98); doc.setFont(undefined, 'normal');
            doc.text(`${os.defeito_relatado}`, 15, 104, {maxWidth: 180});
            doc.line(15, 115, 195, 115);
            doc.setFontSize(12); doc.text(`VALOR TOTAL: R$ ${os.valor_total.toFixed(2)}`, 15, 125);
            doc.text(`GARANTIA: ${os.garantia_dias} DIAS`, 195, 125, {align: 'right'});
            doc.save(`OS_FIX_${os.id}.pdf`);
        }

        async function gerarPDF_Garantia(id) {
            const { data: os } = await _supabase.from('ordens_servico').select('*, clientes(*)').eq('id', id).single();
            const doc = new jspdf.jsPDF();
            
            doc.setFillColor(249, 115, 22); doc.rect(0, 0, 210, 40, 'F'); // Laranja para Garantia
            doc.setTextColor(255); doc.setFontSize(22); doc.setFont(undefined, 'bold'); doc.text('CERTIFICADO DE GARANTIA', 105, 25, {align: 'center'});
            doc.setTextColor(0); doc.setFontSize(14);
            doc.text(`A EletronicFix garante o reparo do equipamento:`, 15, 60);
            doc.setFont(undefined, 'bold'); doc.text(`${os.equipamento}`, 15, 70); doc.setFont(undefined, 'normal');
            doc.text(`Referente √† O.S. #${os.id} para o cliente ${os.clientes.nome}.`, 15, 80);
            doc.text(`Per√≠odo de Garantia: ${os.garantia_dias} dias.`, 15, 95);
            doc.setFontSize(10);
            doc.text('Termos: A garantia cobre apenas o reparo efetuado. Danos f√≠sicos ou l√≠quidos anulam a mesma.', 15, 115, {maxWidth: 180});
            doc.save(`Garantia_FIX_${os.id}.pdf`);
        }

        async function buscarCep(c) { if(!c) return; const r = await fetch(`https://viacep.com.br/ws/${c.replace(/\D/g, '')}/json/`); const d = await r.json(); if(!d.erro) { document.getElementById('c-rua').value = d.logradouro; document.getElementById('c-cidade').value = d.localidade; } }
        
        window.onload = atualizarDados;
    </script>
</body>
</html>